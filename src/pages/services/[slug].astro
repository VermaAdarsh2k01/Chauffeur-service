---
import Layout from "@/layouts/Layout.astro";
import { sanityClient } from "../../lib/sanity";
import ServiceHero from "@/components/ServiceHero";
import ServiceFeatures from "@/components/ServiceFeatures";
import ServiceCards from "@/components/ServiceCards";
import DownloadCTA from "@/components/DownloadCTA";
import ServiceForm from "@/components/ServiceForm";

const { slug } = Astro.params;

const query = `*[_type == "dynamicServicePage" && slug.current == $slug][0]{
  title,
  slug,
  serviceHero{
    title,
    subtitle,
    description,
    backgroundImage{
      "src": src.asset->url,
      alt
    },
    bookButtonText
  },
  serviceFeatures{
    sectionTitle,
    features[]{
      button,
      title,
      content,
      image{
        "src": src.asset->url,
        alt
      },
      link{
        link,
        label
      }
    }
  },
  serviceCards{
    data[]{
      heading,
      description,
      featurePoints[]{
        text
      },
      ctaButton{
        text,
        link
      },
      image{
        "src": src.asset->url,
        alt
      },
      metric{
        icon,
        label,
        value,
        colorScheme
      }
    }
  },
  downloadCTA{
    backgroundImage{
      "src": src.asset->url,
      alt
    },
    heading,
    description,
    ctaButton{
      text,
      link
    }
  }
}`;

// Fallback data in case Sanity data is not available
const Feature = [
  {
    button: "Luxury Cars",
    title: "Premium Luxury Fleet",
    content: "Experience the ultimate in comfort and style with our premium luxury vehicles. Perfect for special occasions, business meetings, or when you simply want to travel in sophistication.",
    image: "/vehicles/mercedes.jpg",
    link: {
      link: "/services/luxury-rentals",
      label: "Book Luxury Car"
    }
  },
  {
    button: "Economy",
    title: "Budget-Friendly Economy Options",
    content: "Get the best value for your money with our reliable and fuel-efficient economy cars. Perfect for city driving, daily commutes, and budget-conscious travelers.",
    image: "/vehicles/dzire.jpg",
    link: {
      link: "/services/economy-rentals",
      label: "Book Economy Car"
    }
  },
  {
    button: "SUVs",
    title: "Spacious SUV Collection",
    content: "Need extra space for family trips or adventure? Our SUV collection offers comfort, safety, and ample storage for all your travel needs.",
    image: "/vehicles/fortuner.jpg",
    link: {
      link: "/services/suv-rentals",
      label: "Book SUV"
    }
  },
  {
    button: "Sports Cars",
    title: "High-Performance Sports Cars",
    content: "Feel the thrill of the road with our collection of high-performance sports cars. Perfect for those who appreciate speed, style, and cutting-edge automotive engineering.",
    image: "/vehicles/porche.jpg",
    link: {
      link: "/services/sports-rentals",
      label: "Book Sports Car"
    }
  },
  {
    button: "Chauffeur",
    title: "Professional Chauffeur Service",
    content: "Sit back and relax while our professional chauffeurs take care of the driving. Perfect for airport transfers, business meetings, and special events.",
    image: "/chauffeur.jpg",
    link: {
      link: "/services/chauffeur-service",
      label: "Book Chauffeur"
    }
  }
];


// Fetch page data with error handling
let page;
try {
  // First, let's check if any pages exist at all
  const allPages = await sanityClient.fetch(`*[_type == "dynamicServicePage"]{title, slug}`);
  
  // Then fetch the specific page
  page = await sanityClient.fetch(query, { slug });

} catch (error) {

  page = null;
}

// Handle case where page is not found
if (!page) {
  console.warn(`No page found for slug: ${slug}`);
  // Return 404 if page not found
  return Astro.redirect('/404');
}
---

<Layout>
  <ServiceHero client:load
    title={page?.serviceHero?.title || "Premium Service"}
    subtitle={page?.serviceHero?.subtitle || "Professional Service"}
    description={page?.serviceHero?.description || "Experience luxury and comfort"}
    backgroundImage={page?.serviceHero?.backgroundImage}
    bookButtonText={page?.serviceHero?.bookButtonText}  
    
  />
  {page?.serviceFeatures?.features && (
    <ServiceFeatures client:load 
      features={page?.serviceFeatures?.features || Feature}
      sectionTitle={page?.serviceFeatures?.sectionTitle}
    />
  )}

  {page?.serviceCards?.data && (
    <ServiceCards client:load data={page?.serviceCards?.data} />
  )}

  {/* Individual Service Form based on slug */}
  <div id="booking-form" class="py-16 bg-gradient-to-br from-green-50 via-white to-emerald-50">
    <div class="container mx-auto px-4">
      <ServiceForm client:load formType={slug || ""} />
    </div>
  </div>

  {page?.downloadCTA && (
    <DownloadCTA client:load data={page?.downloadCTA} />   
  )}
</Layout>